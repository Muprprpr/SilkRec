# SilkRec 系统说明文档

## 项目概述

SilkRec 是一个基于 Wails 框架的 Vue-Go 桌面录屏解决方案，适用于 Windows 环境。核心功能是录制屏幕并记录鼠标位置和状态，在鼠标点击时进行 zoom in 镜头效果，最终生成 MP4 视频。

---

## 一、文件结构说明

### 后端文件（Go）

#### 1. `main.go`
**作用**：程序入口，负责初始化 Wails 应用并启动整个系统。

**创建的方法**：
- `main()` - 主函数，创建应用实例并运行 Wails 应用

**调用的依赖**：
- `NewApp()` - 创建 App 实例（来自 app.go）
- `app.startup()` - 应用启动回调
- `app.shutdown()` - 应用关闭回调

**解决的问题**：
- 应用生命周期管理
- 资源初始化和清理

---

#### 2. `app.go`
**作用**：Wails 桥接层，作为 API 网关，将前端请求转发给后端模块。

**创建的方法**：
- `NewApp()` - 创建新的 App 实例
- `startup(ctx)` - 应用启动时调用，初始化鼠标钩子和文件写入器
- `shutdown(ctx)` - 应用关闭时调用，清理资源

**录制相关 API**：
- `StartRecording(filename)` - 开始录制，打开视频文件并启动鼠标数据录制
- `StopRecording()` - 停止录制，关闭视频文件并停止鼠标数据录制
- `WriteVideoChunk(data)` - 写入视频数据块到文件
- `GetMouseData()` - 获取录制的鼠标数据
- `SaveMouseData(filename)` - 保存鼠标数据到 JSON 文件

**系统相关 API**：
- `GetScreenInfo()` - 获取屏幕信息（宽度、高度、DPI）
- `SetWindowAlwaysOnTop(top)` - 设置窗口置顶

**文件操作 API**：
- `DeleteFile(filepath)` - 删除文件
- `ReadVideoFile(filepath)` - 读取视频文件并返回 base64 编码

**获取录制状态 API**：
- `GetRecordingStatus()` - 获取当前录制状态

**调用的依赖**：
- `hook.NewMouseHook(ctx)` - 创建鼠标钩子（来自 pkg/hook/cursor.go）
- `io.NewFileWriter()` - 创建文件写入器（来自 pkg/io/file_writer.go）
- `sys.GetScreenInfo()` - 获取屏幕信息（来自 pkg/sys/window.go）

**解决的问题**：
- 前端与后端的通信桥接
- 录制流程的协调和控制
- 文件读写管理
- 屏幕信息获取

---

#### 3. `pkg/hook/cursor.go`
**作用**：全局鼠标事件监听模块，使用 gohook 库监听鼠标移动、点击、滚动等事件。

**创建的结构体**：
- `MouseEvent` - 鼠标事件数据结构
  - Timestamp: 时间戳（毫秒）
  - X, Y: 鼠标坐标
  - EventType: 事件类型（move, click_left, click_right, click_middle, hold, scroll）
  - Duration: hold 持续时间（毫秒）
  - Delta: 滚动增量
  - Button: 按钮标识（left, right, middle）

- `MouseHook` - 鼠标钩子管理器
  - ctx: 上下文
  - eventChan: 事件通道
  - mouseData: 鼠标数据列表
  - mouseDataMu: 互斥锁
  - isRecording: 是否正在录制
  - lastX, lastY: 上一次鼠标位置
  - mouseDownTime: 记录鼠标按下时间
  - mouseDownMu: 互斥锁
  - ticker: 定时器（20Hz）
  - immediateChan: 立即发送关键时刻事件的通道

**创建的方法**：
- `NewMouseHook(ctx)` - 创建新的鼠标钩子
- `Start()` - 开始监听鼠标事件
- `Stop()` - 停止监听
- `processEvents()` - 处理原始鼠标事件的主循环
- `handleEvent(ev)` - 处理单个事件
- `addMouseEvent(event)` - 添加鼠标事件到数据列表
- `emitImmediateEvents()` - 立即发送关键时刻事件到前端
- `emitData()` - 定时发送数据到前端
- `StartRecording()` - 开始录制鼠标数据
- `StopRecording()` - 停止录制
- `GetMouseData()` - 获取录制的鼠标数据
- `GetMouseDataJSON()` - 获取鼠标数据的 JSON 格式
- `ClearMouseData()` - 清空鼠标数据

**调用的依赖**：
- `hook.Start()` - 启动 gohook 监听（来自 github.com/robotn/gohook）
- `runtime.EventsEmit()` - 发送事件到前端（来自 github.com/wailsapp/wails/v2/pkg/runtime）

**解决的问题**：
- 全局鼠标事件监听
- 区分不同类型的鼠标事件（移动、点击、按住、滚动）
- 计算鼠标按住持续时间
- 实时和定时发送鼠标数据到前端
- 关键时刻事件立即发送（点击、按住、滚动）

---

#### 4. `pkg/io/file_writer.go`
**作用**：管理视频文件的写入，提供线程安全的文件操作。

**创建的结构体**：
- `FileWriter` - 文件写入器
  - file: 文件对象
  - filePath: 文件路径
  - mu: 互斥锁
  - isOpen: 是否已打开
  - totalBytes: 已写入的总字节数

**创建的方法**：
- `NewFileWriter()` - 创建新的文件写入器
- `Open(filePath)` - 打开文件准备写入
- `Write(data)` - 写入数据块
- `WriteString(data)` - 写入字符串
- `Append(data)` - 追加写入数据
- `Close()` - 关闭文件
- `Sync()` - 同步文件到磁盘
- `GetTotalBytes()` - 获取已写入的总字节数
- `GetFilePath()` - 获取当前文件路径
- `IsOpen()` - 检查文件是否打开
- `DeleteFile()` - 删除当前文件
- `WriteJSON(data)` - 写入 JSON 数据
- `ReadFile(filepath)` - 读取文件内容

**调用的依赖**：
- `os.Create()` - 创建文件（来自 Go 标准库）
- `os.MkdirAll()` - 创建目录（来自 Go 标准库）
- `os.ReadFile()` - 读取文件（来自 Go 标准库）

**解决的问题**：
- 线程安全的文件写入
- 大文件的流式写入
- 文件管理（打开、关闭、删除）
- JSON 数据写入
- 文件读取支持

---

#### 5. `pkg/sys/window.go`
**作用**：Windows 系统级操作，包括屏幕信息获取和窗口管理。

**创建的结构体**：
- `ScreenInfo` - 屏幕信息
  - Width: 屏幕宽度
  - Height: 屏幕高度
  - DPI: 屏幕 DPI

**创建的方法**：
- `GetScreenInfo()` - 获取屏幕信息
- `getSystemMetrics(nIndex)` - 获取系统度量值
- `getDPI()` - 获取屏幕 DPI
- `SetWindowAlwaysOnTop(hwnd, top)` - 设置窗口置顶
- `GetWindowHandle(title)` - 获取窗口句柄
- `HideWindow(hwnd)` - 隐藏窗口
- `ShowWindow(hwnd)` - 显示窗口
- `MinimizeWindow(hwnd)` - 最小化窗口
- `MaximizeWindow(hwnd)` - 最大化窗口
- `MoveWindow(hwnd, x, y, width, height)` - 移动窗口
- `GetWindowRect(hwnd)` - 获取窗口矩形
- `SetWindowPos(hwnd, x, y, width, height)` - 设置窗口位置和大小

**调用的依赖**：
- `syscall.NewLazyDLL()` - 加载 Windows DLL（来自 Go 标准库）
- `user32.NewProc()` - 获取 Windows API 函数（来自 Go 标准库）
- `gdi32.NewProc()` - 获取 GDI32 API 函数（来自 Go 标准库）

**解决的问题**：
- 获取屏幕尺寸和 DPI
- 窗口管理（置顶、移动、调整大小）
- Windows API 调用

---

### 前端文件（JavaScript/Vue）

#### 6. `frontend/src/main.js`
**作用**：前端应用入口，初始化 Vue 应用、路由和状态管理。

**创建的方法**：
- `main()` - 主函数，创建并启动 Vue 应用

**调用的依赖**：
- `createApp()` - 创建 Vue 应用（来自 vue）
- `createPinia()` - 创建 Pinia 实例（来自 pinia）
- `createRouter()` - 创建路由器（来自 vue-router）
- `createWebHashHistory()` - 创建 Hash 历史记录（来自 vue-router）
- `RecordingView` - 录制视图组件（来自 ./views/RecordingView.vue）
- `EditorView` - 编辑视图组件（来自 ./views/EditorView.vue）

**解决的问题**：
- Vue 应用初始化
- 路由配置
- 状态管理初始化
- 视图组件注册

---

#### 7. `frontend/src/App.vue`
**作用**：Vue 根组件，提供路由视图容器。

**创建的方法**：
- 无（仅模板）

**调用的依赖**：
- `router-view` - 路由视图组件（来自 vue-router）

**解决的问题**：
- 提供应用根容器
- 路由视图渲染

---

#### 8. `frontend/src/stores/index.js`
**作用**：状态管理模块导出。

**创建的方法**：
- 无（仅导出）

**调用的依赖**：
- `useRecorderStore` - 录制状态（来自 ./stores/recorder.js）
- `useEditorStore` - 编辑状态（来自 ./stores/editor.js）

**解决的问题**：
- 统一导出状态管理模块

---

#### 9. `frontend/src/stores/recorder.js`
**作用**：录制状态管理，使用 Pinia 管理录制相关的状态。

**创建的状态**：
- `isRecording` - 是否正在录制
- `isPaused` - 是否已暂停
- `recordingTime` - 录制时间（秒）
- `mouseData` - 鼠标事件列表
- `videoChunks` - 视频数据块列表
- `totalBytes` - 总字节数
- `screenInfo` - 屏幕信息
- `config` - 录制配置
- `videoFilePath` - 视频文件路径
- `mouseDataFilePath` - 鼠标数据文件路径
- `error` - 错误信息

**创建的 getters**：
- `formattedTime` - 格式化录制时间
- `mouseEventCount` - 鼠标事件数量
- `chunkCount` - 视频数据块数量
- `hasError` - 是否有错误
- `statusText` - 录制状态文本

**创建的 actions**：
- `startRecording()` - 开始录制
- `stopRecording()` - 停止录制
- `pauseRecording()` - 暂停录制
- `resumeRecording()` - 继续录制
- `incrementTime()` - 增加录制时间
- `setRecordingTime(time)` - 设置录制时间
- `addMouseEvent(event)` - 添加鼠标事件
- `addMouseEvents(events)` - 批量添加鼠标事件
- `clearMouseData()` - 清空鼠标数据
- `addVideoChunk(chunk)` - 添加视频数据块
- `clearVideoChunks()` - 清空视频数据块
- `setScreenInfo(width, height, dpi)` - 设置屏幕信息
- `updateConfig(config)` - 更新录制配置
- `setVideoFilePath(path)` - 设置视频文件路径
- `setMouseDataFilePath(path)` - 设置鼠标数据文件路径
- `setError(error)` - 设置错误
- `clearError()` - 清除错误
- `reset()` - 重置所有状态
- `getMouseDataJSON()` - 获取鼠标数据的 JSON 字符串

**调用的依赖**：
- `defineStore()` - 定义 Pinia store（来自 pinia）

**解决的问题**：
- 录制状态集中管理
- 录制时间管理
- 鼠标数据管理
- 视频数据管理
- 错误处理

---

#### 10. `frontend/src/stores/editor.js`
**作用**：编辑状态管理，使用 Pinia 管理编辑相关的状态。

**创建的状态**：
- `isVideoLoaded` - 视频是否已加载
- `isPlaying` - 是否正在播放
- `currentTime` - 当前播放时间（秒）
- `duration` - 视频时长（秒）
- `mouseData` - 原始鼠标数据
- `smoothedMouseData` - 平滑后的鼠标数据
- `zoomLevel` - 缩放级别
- `zoomPoints` - 缩放关键帧列表
- `config` - 编辑配置
- `playbackSpeed` - 播放速度
- `volume` - 音量
- `isMuted` - 是否静音
- `videoInfo` - 视频信息
- `videoFilePath` - 视频文件路径
- `mouseDataFilePath` - 鼠标数据文件路径
- `exportConfig` - 导出配置
- `error` - 错误信息

**创建的 getters**：
- `formattedCurrentTime` - 格式化当前时间
- `formattedDuration` - 格式化时长
- `progress` - 播放进度
- `mouseEventCount` - 鼠标事件数量
- `hasError` - 是否有错误
- `currentMousePosition` - 当前时间的鼠标位置
- `currentZoom` - 当前缩放级别

**创建的 actions**：
- `loadVideo(filePath, width, height)` - 加载视频
- `loadMouseData(data)` - 加载鼠标数据
- `smoothMousePath()` - 平滑鼠标路径
- `setSmoothedMouseData(data)` - 设置平滑后的鼠标数据
- `play()` - 播放视频
- `pause()` - 暂停视频
- `stop()` - 停止视频
- `seek(time)` - 跳转到指定时间
- `setCurrentTime(time)` - 设置当前时间
- `setDuration(duration)` - 设置视频时长
- `setZoom(level)` - 设置缩放级别
- `addZoomPoint(time, level, x, y)` - 添加缩放关键帧
- `clearZoomPoints()` - 清空缩放关键帧
- `updateConfig(config)` - 更新编辑配置
- `setPlaybackSpeed(speed)` - 设置播放速度
- `setVolume(volume)` - 设置音量
- `setMuted(muted)` - 设置静音
- `updateExportConfig(config)` - 更新导出配置
- `setError(error)` - 设置错误
- `clearError()` - 清除错误
- `reset()` - 重置所有状态
- `getMouseDataJSON()` - 获取鼠标数据的 JSON 字符串
- `getZoomPointsJSON()` - 获取缩放关键帧的 JSON 字符串

**调用的依赖**：
- `defineStore()` - 定义 Pinia store（来自 pinia）

**解决的问题**：
- 编辑状态集中管理
- 视频播放控制
- 鼠标路径平滑
- 缩放控制
- 播放进度管理

---

#### 11. `frontend/src/core/recorder/index.js`
**作用**：录制核心模块导出。

**创建的方法**：
- 无（仅导出）

**调用的依赖**：
- `ScreenCapture` - 屏幕捕获类（来自 ./recorder/ScreenCapture.js）
- `VideoEncoder` - 视频编码类（来自 ./recorder/VideoEncoder.js）

**解决的问题**：
- 统一导出录制核心模块

---

#### 12. `frontend/src/core/recorder/ScreenCapture.js`
**作用**：屏幕捕获模块，使用 getDisplayMedia API 获取屏幕流。

**创建的方法**：
- `constructor()` - 构造函数，初始化属性
- `startCapture(options)` - 开始捕获屏幕
- `stopCapture()` - 停止捕获屏幕
- `createVideoElement()` - 创建视频元素
- `createCanvas(width, height)` - 创建 Canvas 元素
- `waitForVideoReady()` - 等待视频元素准备就绪
- `playVideo()` - 播放视频
- `drawFrame()` - 绘制当前帧到 Canvas
- `getVideoFrame(timestamp)` - 获取当前帧的 VideoFrame 对象
- `getVideoSize()` - 获取视频尺寸
- `getCanvas()` - 获取 Canvas 元素
- `dispose()` - 清理资源

**调用的依赖**：
- `navigator.mediaDevices.getDisplayMedia()` - 浏览器 API
- `document.createElement()` - DOM API
- `new VideoFrame()` - WebCodecs API

**解决的问题**：
- 屏幕流捕获
- 视频元素管理
- Canvas 绘制
- VideoFrame 创建
- 资源清理

---

#### 13. `frontend/src/core/recorder/VideoEncoder.js`
**作用**：视频编码模块，使用 WebCodecs API 进行硬件加速编码。

**创建的方法**：
- `constructor(options)` - 构造函数，初始化编码配置
- `init()` - 初始化编码器
- `encodeFrame(frame)` - 编码一帧
- `handleOutput(chunk, metadata)` - 处理编码输出
- `handleError(error)` - 处理错误
- `start()` - 开始录制
- `stop()` - 停止录制
- `flush()` - 刷新编码器缓冲区
- `getChunks()` - 获取所有编码的数据块
- `clearChunks()` - 清空数据块
- `getFrameCount()` - 获取帧数
- `getStatus()` - 获取录制状态
- `updateOptions(options)` - 更新编码配置
- `reset()` - 重置编码器
- `destroy()` - 销毁编码器

**调用的依赖**：
- `new VideoEncoder()` - WebCodecs API
- `frame.close()` - VideoFrame API

**解决的问题**：
- 硬件加速视频编码
- 编码器配置
- 数据块管理
- 关键帧插入
- 错误处理

---

#### 14. `frontend/src/core/editor/index.js`
**作用**：编辑核心模块导出。

**创建的方法**：
- 无（仅导出）

**调用的依赖**：
- `PixiRenderer` - PixiJS 渲染器（来自 ./editor/PixiRenderer.js）
- `VideoManager` - 视频管理器（来自 ./editor/VideoManager.js）

**解决的问题**：
- 统一导出编辑核心模块

---

#### 15. `frontend/src/core/editor/VideoManager.js`
**作用**：视频资源管理器，管理视频加载、播放、时间轴等功能。

**创建的方法**：
- `constructor(options)` - 构造函数，初始化配置
- `load(src)` - 加载视频
- `play()` - 播放视频
- `pause()` - 暂停视频
- `stop()` - 停止视频
- `seek(time)` - 跳转到指定时间
- `setPlaybackRate(speed)` - 设置播放速度
- `getCurrentFrameCanvas()` - 获取当前帧的 Canvas
- `getCurrentVideoFrame(timestamp)` - 获取当前帧的 VideoFrame
- `getSize()` - 获取视频尺寸
- `getDuration()` - 获取视频时长
- `getCurrentTime()` - 获取当前播放时间
- `getProgress()` - 获取播放进度
- `setVolume(volume)` - 设置音量
- `getVolume()` - 获取音量
- `setMuted(muted)` - 设置静音
- `getVideoElement()` - 获取视频元素
- `getStatus()` - 获取状态
- `dispose()` - 清理资源

**调用的依赖**：
- `document.createElement()` - DOM API
- `new VideoFrame()` - WebCodecs API

**解决的问题**：
- 视频加载和播放控制
- 时间轴管理
- 帧提取
- 视频信息获取

---

#### 16. `frontend/src/core/editor/PixiRenderer.js`
**作用**：PixiJS v8 渲染器，用于视频渲染、鼠标轨迹显示和缩放效果。

**创建的方法**：
- `constructor(options)` - 构造函数，初始化渲染配置
- `init(container)` - 初始化渲染器
- `loadVideo(videoElement)` - 加载视频
- `createMouseSprite(options)` - 创建鼠标精灵
- `updateMousePosition(x, y)` - 更新鼠标位置
- `updateMouseTrail()` - 更新鼠标轨迹
- `clearMouseTrail()` - 清空鼠标轨迹
- `setZoom(level, center, animate)` - 设置缩放级别
- `applyZoom()` - 应用缩放
- `zoomIn()` - 放大
- `zoomOut()` - 缩小
- `resetZoom()` - 重置缩放
- `play()` - 播放视频
- `pause()` - 暂停视频
- `seek(time)` - 跳转到指定时间
- `onTick()` - 帧更新回调
- `getStatus()` - 获取渲染状态
- `resize(width, height)` - 调整大小
- `destroy()` - 销毁渲染器

**调用的依赖**：
- `new PIXI.Application()` - PixiJS API
- `new PIXI.Container()` - PixiJS API
- `PIXI.Texture.from()` - PixiJS API
- `new PIXI.Sprite()` - PixiJS API
- `new PIXI.Graphics()` - PixiJS API
- `gsap.to()` - GSAP 动画库

**解决的问题**：
- WebGL 渲染
- 视频纹理管理
- 鼠标精灵渲染
- 鼠标轨迹绘制
- 缩放效果实现
- 平滑动画

---

#### 17. `frontend/src/core/math/index.js`
**作用**：数学模块导出。

**创建的方法**：
- 无（仅导出）

**调用的依赖**：
- `Smoother` - 平滑器类（来自 ./math/Smoother.js）
- `Bezier` - 贝塞尔曲线类（来自 ./math/Bezier.js）

**解决的问题**：
- 统一导出数学模块

---

#### 18. `frontend/src/core/math/Smoother.js`
**作用**：鼠标路径平滑算法，使用 Catmull-Rom 样条曲线进行平滑处理。

**创建的方法**：
- `constructor(options)` - 构造函数，初始化平滑参数
- `smoothPath(points)` - 平滑路径
- `catmullRom(p0, p1, p2, p3, segments)` - Catmull-Rom 样条曲线插值
- `catmullRomPoint(p0, p1, p2, p3, t)` - 计算 Catmull-Rom 样条曲线上的点
- `interpolateLinear(p0, p1, segments)` - 线性插值
- `bezierPoint(points, t)` - 计算贝塞尔曲线上的点
- `bezierSmooth(points, segments)` - 三次贝塞尔曲线平滑
- `simplifyPath(points, tolerance)` - 简化路径（减少点数）
- `perpendicularDistance(point, lineStart, lineEnd)` - 计算点到线段的垂直距离
- `pathLength(points)` - 计算路径长度
- `resamplePath(points, interval)` - 重采样路径（使点间距均匀）
- `setOptions(options)` - 设置平滑参数

**调用的依赖**：
- 无（纯数学计算）

**解决的问题**：
- 鼠标路径平滑
- Catmull-Rom 样条曲线计算
- 贝塞尔曲线计算
- 路径简化和重采样

---

#### 19. `frontend/src/core/math/Bezier.js`
**作用**：贝塞尔曲线算法（注意：此文件在 core/math 目录下，文件名可能有误）

**创建的方法**：
- （文件读取失败，可能不存在）

**解决的问题**：
- 贝塞尔曲线计算

---

#### 20. `frontend/src/views/RecordingView.vue`
**作用**：录制界面组件，提供屏幕录制控制、预览和状态显示。

**创建的方法**：
- `mounted()` - 组件挂载时调用，初始化鼠标事件监听和屏幕信息获取
- `beforeUnmount()` - 组件卸载前调用，清理资源
- `startRecording()` - 开始录制
- `stopRecording()` - 停止录制
- `saveRecording()` - 保存录制
- `pauseRecording()` - 暂停录制
- `startTimer()` - 启动定时器
- `stopTimer()` - 停止定时器
- `cleanup()` - 清理资源
- `formatBytes(bytes)` - 格式化字节数

**调用的依赖**：
- `useRecorderStore()` - 录制状态（来自 ../stores/recorder.js）
- `useRouter()` - 路由（来自 vue-router）
- `EventsOn()` - Wails 事件监听（来自 ../../wailsjs/runtime/runtime）
- `EventsOff()` - Wails 事件注销（来自 ../../wailsjs/runtime/runtime）
- `StartRecording()` - 开始录制（来自 ../../wailsjs/go/main/App）
- `StopRecording()` - 停止录制（来自 ../../wailsjs/go/main/App）
- `WriteVideoChunk()` - 写入视频数据块（来自 ../../wailsjs/go/main/App）
- `GetScreenInfo()` - 获取屏幕信息（来自 ../../wailsjs/go/main/App）
- `navigator.mediaDevices.getDisplayMedia()` - 浏览器 API
- `MediaRecorder()` - 浏览器 API
- `MediaRecorder.isTypeSupported()` - 浏览器 API

**解决的问题**：
- 屏幕录制控制
- 鼠标事件记录
- 视频数据流式写入
- 录制时间管理
- 暂停/继续录制
- 录制状态显示
- 鼠标隐藏（通过 cursor: 'never' 和 CSS）
- 编解码器兼容性（支持多种编解码器）

---

#### 21. `frontend/src/views/EditorView.vue`
**作用**：编辑界面组件，提供视频播放、缩放控制、鼠标轨迹显示和导出功能。

**创建的方法**：
- `mounted()` - 组件挂载时调用，初始化平滑器、加载数据和渲染器
- `beforeUnmount()` - 组件卸载前调用，清理资源
- `loadData()` - 加载数据
- `initRenderer()` - 初始化渲染器
- `playVideo()` - 播放视频
- `pauseVideo()` - 暂停视频
- `stopVideo()` - 停止视频
- `seekToPosition(event)` - 跳转到指定位置
- `zoomIn()` - 放大
- `zoomOut()` - 缩小
- `resetZoom()` - 重置缩放
- `smoothMousePath()` - 平滑鼠标路径
- `clearMouseTrail()` - 清除鼠标轨迹
- `setPlaybackSpeed()` - 设置播放速度
- `exportVideo()` - 导出视频
- `checkAutoZoom()` - 检查是否需要自动缩放
- `toggleAutoZoom()` - 切换自动缩放
- `cleanup()` - 清理资源

**调用的依赖**：
- `useEditorStore()` - 编辑状态（来自 ../stores/editor.js）
- `PixiRenderer` - PixiJS 渲染器（来自 ../core/editor）
- `VideoManager` - 视频管理器（来自 ../core/editor）
- `Smoother` - 平滑器（来自 ../core/math）
- `EventsOn()` - Wails 事件监听（来自 ../../wailsjs/runtime/runtime）
- `EventsOff()` - Wails 事件注销（来自 ../../wailsjs/runtime/runtime）
- `SaveMouseData()` - 保存鼠标数据（来自 ../../wailsjs/go/main/App）

**解决的问题**：
- 视频播放控制
- 缩放控制
- 鼠标轨迹显示
- 鼠标路径平滑
- 自动缩放（基于点击事件）
- 播放进度控制
- 播放速度控制
- 视频加载错误处理

---

## 二、方法调用依赖体系

### 1. 应用启动流程

```
main.go:main()
  └─> NewApp()
      └─> io.NewFileWriter()
      └─> hook.NewMouseHook()
  
  └─> wails.Run()
      └─> app.startup()
            └─> hook.Start()
                  └─> gohook.Start() [gohook]
            └─> runtime.EventsEmit() [Wails]
```

**解决的问题**：应用生命周期管理、资源初始化

---

### 2. 录制流程

```
RecordingView.vue:startRecording()
  └─> navigator.mediaDevices.getDisplayMedia()
        └─> cursor: 'never' [隐藏鼠标]
  
  └─> MediaRecorder() [多种编解码器支持]
        └─> ondataavailable
              └─> WriteVideoChunk() [Go后端]
                    └─> FileWriter.Write()
                          └─> os.Write()
  
  └─> StartRecording() [Go后端]
        └─> FileWriter.Open()
        └─> os.Create()
  
  └─> EventsOn('mouse-position')
        └─> hook:emitImmediateEvents() [Go后端]
              └─> runtime.EventsEmit()
  
  └─> store.addMouseEvent()
        └─> recorder store: addMouseEvent()
  
  └─> startTimer()
        └─> setInterval()
              └─> store.incrementTime()
```

**解决的问题**：屏幕捕获、视频编码、数据流式写入、鼠标事件监听、时间管理

---

### 3. 鼠标事件处理流程

```
hook:processEvents() [Go后端]
  └─> gohook.Event()
        └─> MouseDown, MouseUp, MouseMove, MouseWheel
              └─> handleEvent()
                    └─> addMouseEvent()
                    └─> emitImmediateEvents()
                          └─> runtime.EventsEmit() [Wails]
                    └─> emitData() [定时发送]
                          └─> runtime.EventsEmit() [Wails]
```

**解决的问题**：全局鼠标事件监听、事件类型区分、实时和定时发送

---

### 4. 编辑流程

```
EditorView.vue:mounted()
  └─> Smoother() [前端]
  
  └─> loadData()
        └─> store.loadMouseData()
        └─> editor store: loadMouseData()
  
        └─> store.loadVideo()
        └─> editor store: loadVideo()
  
  └─> initRenderer()
        └─> VideoManager()
              └─> load()
                    └─> HTMLVideoElement API
  
        └─> PixiRenderer()
              └─> init()
                    └─> PIXI.Application()
              └─> loadVideo()
                    └─> PIXI.Texture.from()
              └─> createMouseSprite()
                    └─> PIXI.Graphics()
              └─> PIXI.Sprite()
  
  └─> checkAutoZoom()
        └─> store.mouseData.filter()
              └─> 找到 click 事件
        └─> zoomIn()
              └─> PixiRenderer:zoomIn()
                    └─> setZoom()
                          └─> PIXI.Container.scale.set()
```

**解决的问题**：视频加载、鼠标数据加载、PixiJS 渲染、鼠标轨迹、缩放控制、自动缩放

---

### 5. 视频播放控制流程

```
EditorView.vue:playVideo()
  └─> VideoManager:play()
        └─> HTMLVideoElement.play()
  
  └─> store.play()
        └─> editor store: play()
  
  └─> PixiRenderer:play()
        └─> PIXI.VideoTexture.play()
```

**解决的问题**：视频播放控制、状态同步

---

### 6. 鼠标路径平滑流程

```
EditorView.vue:smoothMousePath()
  └─> Smoother:smoothPath()
        └─> catmullRom()
              └─> catmullRomPoint()
  
  └─> store.setSmoothedMouseData()
        └─> editor store: setSmoothedMouseData()
  
  └─> SaveMouseData() [Go后端]
        └─> FileWriter:WriteString()
              └─> os.Write()
```

**解决的问题**：鼠标路径平滑、数据保存

---

### 7. 缩放控制流程

```
EditorView.vue:zoomIn()
  └─> PixiRenderer:zoomIn()
        └─> setZoom()
              └─> gsap.to() [GSAP动画]
                    └─> applyZoom()
                          └─> PIXI.Container.scale.set()
                                └─> PIXI.Container.pivot.set()
  
  └─> store.setZoom()
        └─> editor store: setZoom()
```

**解决的问题**：缩放控制、平滑动画、状态同步

---

### 8. 文件写入流程

```
RecordingView.vue:ondataavailable
  └─> WriteVideoChunk()
        └─> FileWriter:Write()
              └─> os.Write()
  
  └─> store.addVideoChunk()
        └─> recorder store: addVideoChunk()
```

**解决的问题**：视频数据流式写入、状态管理

---

### 9. 屏幕信息获取流程

```
RecordingView.vue:mounted()
  └─> GetScreenInfo() [Go后端]
        └─> sys:GetScreenInfo()
              └─> getSystemMetrics()
              └─> user32.NewProc().Call()
  
  └─> store.setScreenInfo()
        └─> recorder store: setScreenInfo()
```

**解决的问题**：屏幕信息获取、状态管理

---

### 10. 路由跳转流程

```
RecordingView.vue:stopRecording()
  └─> router.push()
        └─> vue-router:push()
              └─> EditorView 组件
                    └─> props: videoPath, mouseData
```

**解决的问题**：页面导航、数据传递

---

## 三、关键技术要点

### 1. 鼠标隐藏实现
- **方法 1**：`getDisplayMedia` 中设置 `cursor: 'never'`
- **方法 2**：CSS 样式 `.recording-active .preview-video { cursor: none !important; }`
- **方法 3**：动态 class 绑定 `:class="['recording-view', { 'recording-active': store.isRecording }]"`

### 2. 编解码器兼容性
- 支持多种编解码器：VP9, VP8, WebM, MP4
- 使用 `MediaRecorder.isTypeSupported()` 检测
- 按优先级尝试，确保兼容性

### 3. 数据流式写入
- 使用 `Uint8Array` 存储二进制数据
- 转换为普通数组 `Array.from(uint8Array)` 避免 Wails 序列化问题
- 线程安全的文件写入

### 4. 鼠标事件处理
- 区分不同事件类型：move, click_left, click_right, click_middle, hold, scroll
- 计算鼠标按住持续时间
- 立即发送关键时刻事件（点击、按住、滚动）
- 定时发送鼠标位置（20Hz）

### 5. GPU 加速渲染
- 使用 PixiJS v8 进行 WebGL 渲染
- 使用 WebCodecs API 进行硬件加速编码
- 避免数据回传到 CPU

### 6. 路径平滑算法
- Catmull-Rom 样条曲线
- 三次贝塞尔曲线
- 路径简化和重采样
- 可配置的平滑参数

---

## 四、已修复的问题

### 1. 视频格式错误（MEDIA_ELEMENT_ERROR: Format error）
- 添加了多种编解码器支持
- 使用 `MediaRecorder.isTypeSupported()` 检测
- 根据编解码器自动选择正确的文件扩展名

### 2. "文件未打开"问题
- 调整了事件处理器的设置顺序
- 先设置 MediaRecorder 的事件处理器
- 然后再调用 `StartRecording` 打开文件
- 最后启动 MediaRecorder

### 3. 鼠标隐藏问题
- 在 `getDisplayMedia` 中设置 `cursor: 'never'`
- 添加了 CSS 样式隐藏鼠标
- 添加了动态 class 绑定

### 4. 录制时间记录 bug
- 改进了定时器管理逻辑
- 添加了 `startTimer()` 和 `stopTimer()` 方法
- 确保暂停时时间不会继续增加

### 5. GetScreenInfo 调用问题
- 改进了对返回值的处理
- 支持多种返回格式（数组、对象、默认值）
- 添加了详细的日志记录

---

## 五、待实现功能

### 1. 导出功能
- 当前为占位实现
- 需要实现离屏渲染
- 需要使用 WebCodecs VideoEncoder 重新编码
- 需要将编码后的数据块发送给 Go 后端

### 2. 窗口管理
- `SetWindowAlwaysOnTop` 当前为占位实现
- 需要获取窗口句柄
- 需要调用 Windows API

---

## 六、技术栈总结

### 后端（Go）
- **框架**：Wails v2
- **鼠标监听**：github.com/robotn/gohook
- **文件操作**：os, encoding/json
- **Windows API**：syscall

### 前端（JavaScript）
- **框架**：Vue 3 Composition API
- **状态管理**：Pinia
- **路由**：Vue Router（Hash History）
- **渲染引擎**：PixiJS v8
- **动画**：GSAP
- **Web API**：
  - MediaRecorder
  - getDisplayMedia
  - WebCodecs VideoEncoder
  - VideoFrame

---

## 七、项目特色

1. **GPU 加速**：使用 WebCodecs API 进行硬件加速编码
2. **实时鼠标追踪**：全局鼠标事件监听，支持多种事件类型
3. **路径平滑**：Catmull-Rom 样条曲线和贝塞尔曲线算法
4. **智能缩放**：基于鼠标点击自动缩放
5. **流式写入**：视频数据实时写入磁盘，避免内存溢出
6. **编解码器兼容**：支持多种编解码器，确保浏览器兼容性
7. **模块化设计**：清晰的模块划分，易于维护和扩展
8. **纯 JavaScript 实现**：不使用 TypeScript，降低开发复杂度

---

## 八、使用说明

### 录制流程
1. 点击"开始录制"按钮
2. 选择要录制的屏幕
3. 系统自动隐藏鼠标
4. 开始录制屏幕和鼠标事件
5. 可以暂停/继续录制
6. 点击"停止录制"结束录制
7. 自动跳转到编辑界面

### 编辑流程
1. 查看录制的视频
2. 播放/暂停/停止视频
3. 使用缩放控制查看细节
4. 查看鼠标轨迹
5. 平滑鼠标路径
6. 基于点击自动缩放
7. 导出最终视频

---

## 九、注意事项

1. **浏览器兼容性**：需要使用支持 WebCodecs 的现代浏览器（Chrome、Edge）
2. **Windows 环境**：当前仅支持 Windows 系统
3. **文件路径**：使用相对路径，Wails 会自动处理
4. **性能优化**：使用 GPU 加速编码，避免 CPU 瓶颈
5. **内存管理**：流式写入视频数据，避免内存溢出

---

## 十、总结

SilkRec 是一个功能完整的屏幕录制解决方案，采用 Wails 框架结合 Vue.js 和 Go 后端，实现了：
- 屏幕录制（隐藏鼠标）
- 鼠标事件追踪（移动、点击、按住、滚动）
- 视频播放和编辑
- 鼠标路径平滑
- 缩放控制
- 自动缩放功能

项目采用模块化设计，代码结构清晰，易于维护和扩展。使用 GPU 加速编码，确保高性能和流畅的用户体验。
